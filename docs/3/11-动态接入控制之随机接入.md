- 如图所示，多台主机连接在一根总线上，各主机随机发送帧

- 当两台或多台主机同时发送帧时，信号就会产生碰撞

<img src="https://gitee.com/pj-l/imgs-1/raw/master/image-20220321192016272.png" alt="image-20220321192016272" style="zoom:50%;" />

- 或者当某台主机正在使用总线发送帧，突然另一台主机也要发送帧，这也会产生碰撞

<img src="https://gitee.com/pj-l/imgs-1/raw/master/image-20220321192042494.png" alt="image-20220321192042494" style="zoom:50%;" />

> 显然，如何协调总线上各主机的工作，以尽量避免碰撞的产生，是一个必须解决的重要问题
>
> 早期的共享式以太网，采用载波监听多址接入/碰撞检测，也就是 CSMA/CD 协议来解决该问题
> 
> （`C`arrier `S`ense `M`ultiple `A`ccess / `C`ollision `D`etection）

---

#### 多址接入 MA

- 多址接入的意思是：

	- 多个主机（也可称为「站」或「站点」）连接在一条总线上，竞争使用总线

<img src="https://gitee.com/pj-l/imgs-1/raw/master/image-20220321200425843.png" alt="image-20220321200425843" style="zoom:40%;" />

#### 载波监听 CS

- 载波监听的意思是：

	- 每一个站在发送帧之前要先检测一下总线上是否有其他站点在发送帧（可以比喻为“先听后说”）

	- 若检测到总线空闲 96 比特时间，则发送帧

	- 若检测到总线忙，则继续检测，待到总线转为空闲 96 比特时间再发送帧

- 96 比特时间：

	- 指的是发送 96 比特所耗费的时间，也称为「帧间最小间隔」
	
	- 其作用是：

		- 使接收方可以检测出一个帧的结束

		- 也使得所有其他站点都能有机会平等竞争信道并发送帧

#### 碰撞检测 CD

- 碰撞检测的意思是：

	- 每一个正在发送帧的站，都在一边发送帧，一边检测碰撞（可以比喻为“边说边听”）

	- 一旦发现总线上出现碰撞，则立即停止发送，退避一段随机时间后，再次重新发送（可以比喻为“一旦冲突，立即闭嘴；等待时机，再次开讲”）

---

#### 举个例子

- 假设主机 C 要发送帧，它会首先进行载波监听，检测到总线空闲 96 比特时间后，发送帧

<img src="https://gitee.com/pj-l/imgs-1/raw/master/image-20220321202710465.png" alt="image-20220321202710465" style="zoom:40%;" />

- 假设在主机 C 使用总线发送帧的过程中，主机 B 也要发送帧，则主机 B 也会先进行载波监听，却发现总线忙，于是主机 B 持续检测总线

- 一旦主机 B 发现总线空闲 96 比特时间，就会立即发送帧，且一边发送一边进行碰撞检测，只要没检测到碰撞，则可以继续发送帧的剩余部分

<img src="https://gitee.com/pj-l/imgs-1/raw/master/image-20220321202811023.png" alt="image-20220321202811023" style="zoom:40%;" />

- 假设在主机 B 发送帧的过程中，主机 C 也要发送帧，则主机 C 也会先进行载波监听

- （但在 96 比特时间中，主机 B 广播的信号还没到达主机 C，主机 C 就会误以为总线空闲，于是到了 96 比特时间主机 C 就会发送帧）

- 这必然会导致碰撞

<img src="https://gitee.com/pj-l/imgs-1/raw/master/image-20220321202911868.png" alt="image-20220321202911868" style="zoom:40%;" />

- 在产生碰撞的时刻，主机 B 和主机 C 都在一边发送帧一边进行碰撞检测，但暂时都没检测到碰撞

- 碰撞信号沿总线传播，在本例中，主机 C 会比主机 B 更早检测到碰撞并停止发送

<img src="https://gitee.com/pj-l/imgs-1/raw/master/image-20220321203025123.png" alt="image-20220321203025123" style="zoom:40%;" />

- 主机 C 退避一段随机时间后，重新再发送之前所发送的帧

- 当主机 B 检测到碰撞后，也会立即停止发送，退避一段随机时间后，重新再发送之前所发送的帧

<img src="https://gitee.com/pj-l/imgs-1/raw/master/image-20220321203258102.png" alt="image-20220321203258102" style="zoom:40%;" />

- 以太网还采取了一种叫做「强化碰撞」的措施

	- 指的是当发送帧的站点一旦检测到碰撞，除了立即停止发送之外，还要再发送 32 比特或 48 比特的人为干扰信号（Jamming Signal）

	- 以便有足够多的碰撞信号，使所有站点都能检测到碰撞

#### 争用期（碰撞窗口）

![image-20220322072125144](https://gitee.com/pj-l/imgs-1/raw/master/image-20220322072125144.png)

- 如图所示，主机 A 和 D 处于总线型以太网的两端，以太网端到端单程的传播时延记为 τ ，纵坐标为时间

- 假设在时刻 0 主机 A 要发送帧，当检测到总线空闲 96 比特时间后，发送帧

- 在时刻 τ-δ 主机 D 也要发送帧，当检测到总线空闲 96 比特时间后，发送帧

> 注意：主机 D 检测到总线空闲，但实际上总线并不空闲，只是主机 D 检测不出来

- 这必然会导致碰撞

- 发生碰撞的时刻为 τ-δ/2

- 之后，碰撞信号会陆续传播到主机 D 和主机 A

- 主机 D 检测到碰撞的时刻为 τ，而主机 A 检测到碰撞的时刻为 2τ-δ

- 可知，主机最多经过 2τ，也就是 δ->0 就可检测到本次发送是否遭受了碰撞

> 因此，以太网的端到端往返传播时延 2τ 就称为争用期（碰撞窗口）

- 发送帧的主机经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会产生碰撞

- 每一个主机在自己发送帧之后的一小段时间内，存在遭遇碰撞的可能性，这一小段时间是不确定的，它取决于另一个发送帧的主机到本主机的距离，但不会超过总线的端到端往返传播时延（即：一个争用期时间）

> 显然，在以太网中主机越多，端到端往返传播时延越大，发生碰撞的概率也越大
>
> 因此：共享式以太网不能连接太多主机，使用的总线也不能太长
>
> 带宽为 10 Mbps 的以太网将争用期定为 512 比特发送时间，即：51.2 μs（微秒），因此其总线长度不能超过 5120 m
>
> 但考虑到其他因素（eg：信号衰减），以太网规定总线长度不能超过 2500 m