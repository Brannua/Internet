> CSMA/CA（`C`arrier `S`ense `M`ultiple `A`ccess / `C`ollision `A`voidance）
>
> 载波监听多址接入/碰撞避免

![image-20220322120905809](https://gitee.com/pj-l/imgs-1/raw/master/image-20220322120905809.png)

> 思考：
>
> 既然 CSMA/CD 协议已经成功地应用于使用广播信道的有线局域网
>
> 那么同样使用广播信道的无线局域网能否使用 CSMA/CD 协议呢 ？

![image-20220322171338032](https://gitee.com/pj-l/imgs-1/raw/master/image-20220322171338032.png)

- 如图所示，有 4 个无线站点

	- A 的信号范围可以覆盖到 B，但不能覆盖到 C

	- C 的信号范围可以覆盖到 B，但不能覆盖到 A

- 即：A 和 C 都检测不到对方的无线信号

<img src="https://gitee.com/pj-l/imgs-1/raw/master/image-20220322171617713.png" alt="image-20220322171617713" style="zoom:50%;" />

- 当 A 和 C 都要给 B 发送帧时，就会产生碰撞，但 A 和 C 无法检测到碰撞

> 这种未能检测出信道上其他站点信号的问题叫做「隐蔽站问题」，上图的 A 和 C 互为隐蔽站

- 而同样使用广播信道的有线局域网据不存在这样的问题，例如下图

- 总线上某个主机发送的信号，最多经过一个总线端到端传播时延，就会被总线上的各主机接收到

- 而总线上产生的碰撞信号，最多经过一个总线端到端往返传播时延，也会传遍总线

![image-20220322172119964](https://gitee.com/pj-l/imgs-1/raw/master/image-20220322172119964.png)

---

- 因此

	- 802.11 无线局域网使用 CSMA/CA 协议
		- 即：在 CSAM 的基础上，只实现 CA（碰撞避免），而不再实现 CD（碰撞检测）
		
	- 由于（不可能避免所有的碰撞 & 无线信道误码率较高）
	
		- 故 802.11 标准还使用了「数据链路层确认机制」，具体为停止等待协议，来确保数据被正确接收

---

- 802.11 无线局域网的 MAC 层标准定义了 2 种不同的媒体接入控制方式

	1. 分布式协调功能 DCF（`D`istributed `C`oordination `F`unction）

		- 这种方式没有中心控制站点，每个站点使用 CSMA/CA 协议通过争用信道来获取发送权，这是 802.11 定义的默认方式
	
	2. 点协调功能 PCF（`P`oint `C`oordination `F`unction）

		- 这种方式使用集中控制的接入算法（一般在接入点 AP 实现集中控制），这是 802.11 定义的可选方式，实际较少使用

---

- 802.11 标准规定

	- 所有站点都必须在持续检测到信道空闲一段指定时间后才能发送帧，这段时间被称为「帧间间隔 IFS（`I`nter`f`rame `s`pacing）」

- 帧间间隔的长度取决于站点要发送的帧的类型

  - 高优先级的帧需要等待的时间较短，因此可优先获得发送权

  - 低优先级的帧需要等待的时间较长

		- 若某个站的低优先级帧还没来得及发送，而其他站的高优先级帧已经发送到了信道上，则信道就变成了忙状态

		- 而低优先级帧就只能推迟发送，这样就减少了发生碰撞的机会

- 常用的 2 种帧间间隔如下

	1. 最短帧间间隔 SIFS（28μs），用来分隔开属于一次对话的各帧；一个站点应当能够在这段时间内从发送方式切换到接收方式

	使用 SISF 的帧类型有（ACK 帧、CTS 帧、由过长的 MAC 帧分片后的数据帧、所有回答 AP 探寻的帧、在 PCF 方式中接入点 AP 发送出的任何帧）
	
	2. DCF 帧间间隔 DIFS（128μs），在 DCF 方式中用来发送数据帧和管理帧

---

#### CSMA/CA 协议的工作原理

![image-20220323093918128](https://gitee.com/pj-l/imgs-1/raw/master/image-20220323093918128.png)

- 如图所示都是无线站点，横坐标为时间

- 假设无线信道是空闲的，源站有数据帧要发送，当源站检测到信道空闲，则在等待帧间间隔 DIFS 后发送数据帧

- 目的站若正确接收到该数据帧，则经过帧间间隔 SIFS 后，向源站发送确认帧 ACK

- 注意：

	- 若源站在规定时间内没有收到确认帧 ACK（由重传计时器控制这段时间）

		- 就必须重传该数据帧，直到收到确认为止

		- 或者经过若干次的重传失败后放弃发送

- 思考：

	- 源站为什么在检测到信道空闲后还要再等待一个帧间间隔 DIFS 后才发送数据帧呢 ？

	- 这是因为考虑到其他的站可能有高优先级的帧要发送（若有，就让高优先级的帧先发送）

- 思考：

	- 目的站为什么在正确接收数据帧后还要再等待一个最短帧间间隔 SIFS 后才发送 ACK 确认帧呢 ？

	- 这是因为 SIFS 用于将属于一次对话的各帧分隔开，一个站点应当能够在这段时间内从发送方式切换到接收方式

---

- 如图所示，在源站和目的站的一次对话过程中，无线信道处于忙状态

<img src="https://gitee.com/pj-l/imgs-1/raw/master/image-20220323094742886.png" alt="image-20220323094742886" style="zoom:40%;" />

- 无线信道处于忙状态时，若其他无线站点要发送数据，则必须退避

- 当信道从忙状态转换到空闲状态，并经过一个帧间间隔 DIFS

- 其他要发送数据的无线站点，还需退避一段随机时间后才能发送

> 思考：
>
> 既然信道已经由忙转为空闲，且经过了帧间间隔 DIFS，那为什么还要再退避一段随机时间才能使用信道而不是立即使用信道呢 ？
>
> 这样做的目的在于：防止多个站点同时发送数据而产生碰撞

---

- 当站点检测到信道是空闲的，并且所发送的数据帧不是成功发送完上一个数据帧之后立即连续发送的数据帧，则不使用退避算法

- 而以下情况必须使用退避算法

	1. 在发送数据帧之前检测到信道处于忙状态时，必须使用退避算法

	2. 在每次重传一个数据帧时，必须使用退避算法

	3. 在每次成功发送后要连续发送下一个帧时，必须使用退避算法（这是为了避免一个站长时间占用信道）

#### CSMA/CA 协议的退避算法

- 在执行退避算法时，站点为退避计时器设置一个随机的退避时间

	- 当退避计时器的时间减小到 0 时，就开始发送数据

	- 当退避计时器的时间还未减小到 0 而信道又转变为忙状态，则冻结退避计时器，待到信道重新变为空闲，再经过帧间间隔 DIFS 后，继续启动退避计时器

---

- 在进行第 i 次退避时，退避时间在时隙编号{0，1，...，2^(2+i) - 1}中随机选择一个，再乘以基本退避时间（即：一个时隙的长度）就可以得到随机的退避时间

- 这样做是为了使不同站点选择相同退避时间的概率减少

- 当时隙编号达到 255 时（对应于第 6 次退避）就不再增加了

---

- 举例说明

<img src="https://gitee.com/pj-l/imgs-1/raw/master/image-20220323112550801.png" alt="image-20220323112550801" style="zoom:40%;" />

- 如图所示，A、B、C、D、E 是 5 个无线站点，横坐标为时间

- 假设 A 正在占用无线信道发送帧，在 A 的发送过程中，B、C、D 也要发送帧（这里用向上的箭头表示），于是进行载波监听，发现信道忙，退避

- 根据退避算法选择出一个随机的退避时间，并在每个时隙对信道进行一次检测

- 当检测到信道由忙状态转为空闲状态，且经过帧间间隔 DIFS 后，退避计时器开始倒计时

- 假设 C 的退避时间最短，当 C 的退避计时器到时后，C 立即开始发送帧，此时信道由空闲状态转换为忙状态

- 当 B 和 D 检测到信道忙后，就冻结各自剩余的退避时间

- 假设在 C 占用无线信道发送帧的过程中，E 也要发送帧，于是进行载波监听，发现信道忙，退避

- 根据退避算法选择出一个随机的退避时间，并在每个时隙对信道进行一次检测

- 当检测到信道由忙状态转为空闲状态，且经过帧间间隔 DIFS 后，退避计时器开始倒计时

- 当 B 和 D 检测到信道由忙状态转为空闲状态，且经过帧间间隔 DIFS 后，退避计时器重新开始从上次冻结的剩余退避时间开始倒计时

- D 的退避计时器会先到时，D 立即开始发送帧，此时信道由空闲状态转换为忙状态

- 当 B 和 E 检测到信道忙后，就冻结各自剩余的退避时间

- 当 D 发送完帧后，信道转为空闲状态

- 当 B 和 E 检测到信道由忙状态转为空闲状态，且经过帧间间隔 DIFS 后，退避计时器重新开始从上次冻结的剩余退避时间开始倒计时

- E 的退避计时器会首先到时，E 立即开始发送帧，此时信道由空闲状态转换为忙状态，当 B 检测到信道忙后，就冻结自己剩余的退避时间

- 当 E 发送完帧后，信道将转为空闲状态

- 当 B 检测到信道由忙状态转换为空闲状态，且经过帧间间隔 DIFS 后，退避计时器重新开始从上次冻结的退避剩余时间开始倒计时

- 当 B 的退避计时器到时后，B 立即开始发送帧

- 若 B 发送完这一帧后还有帧要发送，则在检测到信道空闲，且经过帧间间隔 DIFS 后，还必须再退避一段随机时间后才能发送

#### CSMA/CA 协议的「信道预约」和「虚拟载波监听」

