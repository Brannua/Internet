> 以太网交换机工作在（数据链路层 & 物理层）
> 
> 目前（2022）市场上也有包含网络层功能的交换机 ！称为「三层交换机」 ！
> 
> 以太网交换机收到帧后，会在帧交换表中查找帧的目的 MAC 地址所对应的接口号，然后通过该接口转发帧

> 以太网交换机是一种即插即用的设备，刚通电启动时其内部的帧交换表是空的
> 
> 随着网络中各主机间的通信，以太网交换机会通过自学习算法自动逐渐建立起帧交换表

> 接下来举例说明以太网交换机自学习和转发帧的流程

- 如图所示，相连的 2 台以太网交换机，各自连接了 3 台主机，形成了一个交换式以太网

- 为简单起见

	- 我们仅用 1 个大写字母表示各主机的网卡上固化的 MAC 地址

	- 我们假设各主机知道网络中其它主机的 MAC 地址，而无需进行 ARP

![image-20220327162429764](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-picgo/image-20220327162429764.png)

- **假设主机 A 向主机 B 发送数据帧**，该帧从交换机 1 的接口 1 进入交换机 1

- 交换机 1 首先进行「登记」，即：

	- 将该帧的源 MAC 地址 A 记录到自己的帧交换表中

	- 将该帧进入自己的接口的接口号 1 对应地记录到帧交换表中

- 上述登记工作就是交换机的自学习

---

- 然后，交换机 1 转发该帧

	- 首先，由于该帧的目的 MAC 地址是 B，于是在帧交换表中查找 MAC 地址 B，发现找不到

	- 于是向除该帧进入交换机的接口外的其它所有接口转发该帧，这被称为“泛洪”

- 不难看出，交换机刚通电工作的时候还是“比较笨”的，它还没有足够的知识来明确该往哪转发帧，所以只能进行低效的广播动作咯

---

- 主机 B 的网卡收到该帧后，根据帧的目的 MAC 地址 B，就知道这正是发给自己的帧，于是接受该帧

- 主机 C 的网卡收到该帧后，根据帧的目的 MAC 地址 B，就知道这不是发给自己的帧，于是丢弃该帧

---

- 该帧会从交换机 2 的接口 2 进入交换机 2

- 交换机 2 也会首先进行「登记」，即：

	- 将该帧的源 MAC 地址 A 记录到自己的帧交换表中

	- 将该帧进入自己的接口的接口号 2 对应地记录到帧交换表中

- 然后，交换机 2 转发该帧

	- 首先，由于该帧的目的 MAC 地址是 B，于是在帧交换表中查找 MAC 地址 B，发现找不到

	- 于是向除该帧进入交换机的接口外的其它所有接口转发该帧（“洪泛”）

	- 主机 D、E、F 都会收到该帧，根据帧的目的 MAC 地址 B，就知道这不是发给自己的帧，于是丢弃该帧

---

- **假设接下来主机 B 向主机 A 发送数据帧**，该帧从交换机 1 的接口 3 进入交换机 1

- 交换机 1 也会首先进行「登记」，即：

	- 将该帧的源 MAC 地址 B 记录到自己的帧交换表中

	- 将该帧进入自己的接口的接口号 3 对应地记录到帧交换表中

- 然后，交换机 1 转发该帧

	- 首先，由于该帧的目的 MAC 地址是 A，于是在帧交换表中查找 MAC 地址 A，显然可以找到

	- 由于 MAC 地址 A 对应接口号 1，所以直接从接口 1 转发该帧

	- 主机 A 的网卡收到该帧后，根据帧的目的 MAC 地址 A，就知道这正是发给自己的帧，于是接受该帧

---

- **假设接下来主机 E 向主机 A 发送数据帧**，该帧从交换机 2 的接口 3 进入交换机 2

- 交换机 2 首先进行「登记」，即：

	- 将该帧的源 MAC 地址 E 记录到自己的帧交换表中

	- 将该帧进入自己的接口的接口号 3 对应地记录到帧交换表中

- 然后，交换机 2 转发该帧

	- 由于该帧的目的 MAC 地址是 A，于是在帧交换表中查找 MAC 地址 A，显然可以找到

	- 由于 MAC 地址 A 对应接口号 2，所以直接从接口 2 转发该帧

- 该帧从交换机 1 的接口 4 进入交换机 1

- 交换机 1 首先进行「登记」，即：

	- 将该帧的源 MAC 地址 E 记录到自己的帧交换表中

	- 将该帧进入自己的接口的接口号 4 对应地记录到帧交换表中

- 然后，交换机 1 转发该帧

	- 由于该帧的目的 MAC 地址是 A，于是在帧交换表中查找 MAC 地址 A，显然可以找到

	- 由于 MAC 地址 A 对应接口号 1，所以直接从接口 1 转发该帧

- 主机 A 的网卡收到该帧后，根据帧的目的 MAC 地址 A，就知道这正是发给自己的帧，于是接受该帧

#### 交换机丢弃帧的情况

- 为了演示该情况，我们给交换机 1 的接口 1 再连接一台主机 G

- 为简单起见，没有画出集线器

- 这样，主机 A、G、以及交换机 1 的接口 1 就共享同一条总线

![image-20220328165826817](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-picgo/image-20220328165826817.png)

- 假设主机 G 向主机 A 发送数据帧

- 数据帧通过总线进行传输，主机 A 和交换机 1 的接口 1 都可以收到

- 主机 A 的网卡收到该帧后，根据帧的目的 MAC 地址 A，就知道这正是发给自己的帧，于是接受该帧

- 交换机 1 收到该帧后，首先进行「登记」，然后尝试转发该帧

	- 首先，由于该帧的目的 MAC 地址是 A，于是会在帧交换表中查找 MAC 地址 A，显然可以找到

	- 由于 MAC 地址 A 对应接口号 1，但**由于该帧正是从接口 1 进入交换机 1 的，所以交换机 1 不会再将该帧从接口 1 转发出去，而是直接丢弃该帧 ！**

---

- 随着网络中各主机都发送了数据帧后，网络中的各交换机就可以学习到各主机的 MAC 地址，以及它们与自己各接口的对应关系

> 注意：
> 
> 帧交换表中的每条记录都有“保质期”，到期就会自动删除 ！
> 
> 这是因为 MAC 地址与交换机接口的对应关系是有可能改变的 ！
> 
> 例如：交换机某接口所连接的主机更换成了另一台主机
> 
> 再例如：主机中的网卡坏了，更换了新的网卡

#### 习题

![image-20220328201126555](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-picgo/image-20220328201126555.png)

![image-20220328201328932](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-picgo/image-20220328201328932.png)

![image-20220328201626924](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-picgo/image-20220328201626924.png)

#### 小结

![image-20220328201731154](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-picgo/image-20220328201731154.png)
